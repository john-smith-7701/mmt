<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>PDF編集ツール（サーバー連携）</title>
  <link rel="stylesheet" href="css/postscript4pdf.css">
  <style>
    .menuCel3 {
        display: none;
    }
    #bodyApplication {
        display: none;
    }
    .panel {
        top:0em;
        left:0em;
    }
    .disabled {
        display: none;
    }
  </style>
</head>
<body>
<div id="panel" class="panel">
 <div class="flex">
  <div class="menuCel2">
    PDF :<input type="file" id="pdf-upload" accept="application/pdf">
    Data:<input type="file" id="load-json" accept=".json">
    <button id="sendToServer" class="metal-box">PDFを生成</button>
    <button id="loadServerPdf">サーバーPDFを読み込む</button>
  </div>
  <div class="menuCel3">
    <label>色: <input type="color" id="colorPicker" value="#000000"></label>
    <label>補正値：<input type="number" id="cvTop" value="0"></label>
    <button id="save-json" class="metal-box">保存</button>
    <label>フォント名:
      <select id="fontNameSelect">
        <option value="'IPAmjMincho'">IPAmj明朝</option>
        <option value="Arial">Arial</option>
        <option value="Times New Roman">Times New Roman</option>
        <option value="'MS Gothic'">MS ゴシック</option>
      </select>
    </label>
    <label>サイズ:
      <select id="fontSizeSelect">
        <option value="12">12px</option>
        <option value="14">14px</option>
        <option value="16" selected>16px</option>
        <option value="18">18px</option>
        <option value="20">20px</option>
        <option value="24">24px</option>
        <option value="32">32px</option>
      </select>
    </label>
    <select id="text-align">
      <option value="left">左寄せ</option>
      <option value="right">右寄せ</option>
      <option value="vertical">縦書き</option>
      <option value="none">白抜き</option>
    </select>
    <hr>
    <button id="copy-selected">選択コピー</button>
    <button id="align-left">｜←</button>
    <button id="align-top">上揃</button>
    <label>画像:
        <input type="file" id="image-upload" accept="image/*">
    </label>
    <hr>
    <div class="radioPanel">
      <input type="radio" id="select1" name="mode" value="create" checked>
      <label for="select1">新規作成</label>
      <input type="radio" id="select2" name="mode" value="select">
      <label for="select2">選択</label>
      <input type="radio" id="select3" name="mode" value="order">
      <label for="select3">入力順</label>
    </div>
    <br><br>
    <input type="text" id="textInput">
    <table id="tblApplication" width="100%">
    </table>
  </div>
 </div>
</div>
<div id="orderPnl" class="orderPnl">
  <table id="tblApplication2" width="100%">
    <thead>
     <tr class="fixed00"><th class="alignHCenter" width="100%">__編集__</th>
    </thead>
    <tbody id="bodyApplication2">
    </tbody>
  </table>
</div>
<br><br><br>

<canvas id="pdf-canvas"></canvas>
<div id="bodyApplication"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
<script src="js/postscript4pdf.js"></script>
<script>
  const orderTbl2 = document.getElementById("bodyApplication2");
  var focusable = [];
  var textes = [];
  var starti = '';
  var enterFlg = false;
  var hiduke = {};
  var oya = {};
  var hidukeID = '';
  document.getElementById('select3').click();
  const loadJsonInput = document.getElementById('load-json');
  loadJsonInput.addEventListener('change', function () {
      makeInputArea();
  });
  document.getElementById('loadServerPdf').addEventListener('click', function () {
      makeInputArea();
  });

  function makeInputArea() {
      setTimeout(function(){
        texts = ps4pdf.getTexts();
        orderTbl2.innerHTML = '';
        mae = '';

        texts.forEach((t,i) => {
            t.selected = false;  //全セレクトをクリア
            if(t.textAlign != 'none'){
                const template = document.createElement('template');
                let inputType = "text";
                let element = "";
                let disabled = '';
                let labelName = t.name;
                const match = t.name.match(/（(元号|年|月|日|年月日)）/);
                if(match){
                    inputType = "date";
                    element = match[1];
                    if(hidukeID === ''){
                        hidukeID = i;
                        hiduke[hidukeID] = [];
                        hiduke[hidukeID].push(hidukeID);
                    }else{
                        hiduke[hidukeID].push(i);
                        inputType = "text";
                        disabled = 'disabled';
                    }
                    oya[i] = hidukeID;
                    labelName = labelName.replace(/（.*）/,'');
                }else{
                    if(hidukeID !== ''){
                        mae = hidukeID;
                    }
                    hidukeID = '';
                }
                template.innerHTML = `<tr id="tr${i}" data-id="${i}" draggable="true" class="fixed10 ${disabled}">
                 <td>${labelName}<br><input type="${inputType}" data-type="${inputType}" data-element="${element}" data-id="${i}" id="input${i}" value="${t.text}"></td></tr>`;
                orderTbl2.appendChild(template.content.firstElementChild);
                if(mae !== ''){
                    focusable[mae] = i;
                }
                if(starti === ''){
                    starti = i;
                }
                mae = i;

            }
        });
        focusable[mae] = starti;
      },1000);
      setTimeout(function(){
        const input = document.getElementById(`input${starti}`);
        texts[starti].selected = true;
        enterFlg = true;
        ps4pdf.setTexts(texts);
        ps4pdf.redrawCanvas();
        input.focus();
        input.select();
        
        document.querySelectorAll('input').forEach(el => {
          el.addEventListener('focus', () => {
            const match = el.id.match(/input(\d+)$/);
            if(!match){return;}
            let i = match[1];
            el.style.backgroundColor = 'lightyellow';
            if(enterFlg){
                enterFlg = false;
            }else{
                texts[i].selected = true;
                ps4pdf.setTexts(texts);
                ps4pdf.redrawCanvas();
            }
          });
          el.addEventListener('blur', () => {
            const match = el.id.match(/input(\d+)$/);
            if(!match){return;}
            let inputType = el.dataset.type;
            let element = el.dataset.element;
              console.log(`${inputType} : ${element}`);
            let i = match[1];
            if(inputType == 'date'){
                editymd(el,i,element);
                enterFlg = false;
            }
            el.style.backgroundColor = '';
            blueTab(i,el)
          });
        });
      },1500);
  }

  document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
      const el = e.target;
      const match = el.id.match(/input(\d+)$/);
      if(match){
        texts[focusable[match[1]]].selected = true;
        blueTab(match[1],el);
        enterFlg = true;
        ps4pdf.redrawCanvas();
      }
    }
  });
  //離れる時にデータをセーブ
  function blueTab(i,el){
    if(el.dataset.type != 'date'){
      texts[i].text = el.value;
    }
    texts[i].selected = false;
    if(i in hiduke){
        hiduke[i].forEach(ii => {texts[ii].selected = false;});
    }
    ps4pdf.setTexts(texts);
  }
  function editymd(el,i,element){
      const value = el.value;
      const ymd = new Date(value);
      let gymd;
      if(hiduke[el.dataset.id].length === 4){
        gymd = ymd.toLocaleDateString("ja-JP-u-ca-Japanese", { era: "long" });
        const match = gymd.match(/^(\D+)(\d+)\D+(\d+)\D+(\d+)$/);
        if(match){
            hiduke[el.dataset.id].forEach((id,i) => {
                texts[id].text = match[i+1];
                if(i != 0){
                    document.getElementById(`input${id}`).value = match[i+1];
                }
            });
        }
      }
      console.log(`${value} -> ${gymd}`);
      console.log(hiduke[el.dataset.id]);
  }
</script>
</body>
</html>

